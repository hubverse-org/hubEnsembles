<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>hubEnsembles • hubEnsembles</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="hubEnsembles">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">
    <a href="https://hubdocs.readthedocs.io/en/latest/" class="external-link"><img src="https://raw.githubusercontent.com/hubverse-org/hubStyle/main/inst/hubverse.png" id="logo" height="30" alt="hubverse"></a>
    <a class="navbar-brand me-2" href="../index.html">hubEnsembles</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"></ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="active nav-item"><a class="nav-link" href="../articles/hubEnsembles.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/hubverse-org/hubEnsembles/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>hubEnsembles</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/hubverse-org/hubEnsembles/blob/main/vignettes/articles/hubEnsembles.Rmd" class="external-link"><code>vignettes/articles/hubEnsembles.Rmd</code></a></small>
      <div class="d-none name"><code>hubEnsembles.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <code>hubEnsembles</code> package provides a flexible framework
for aggregating model outputs, such as forecasts or projections, that
are submitted to a hub by multiple models and combined into ensemble
model outputs. The package includes two main functions:
<code>simple_ensemble</code> and <code>linear_pool</code>. We illustrate
these functions in this vignette, and briefly compare them.</p>
<p>This vignette uses the following R packages:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hubverse-org/hubUtils" class="external-link">hubUtils</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hubverse-org/hubVis" class="external-link">hubVis</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hubverse-org/hubEnsembles" class="external-link">hubEnsembles</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="example-data-a-forecast-hub">Example data: a forecast hub<a class="anchor" aria-label="anchor" href="#example-data-a-forecast-hub"></a>
</h2>
<p>We will use an example hub provided by the hubverse to demonstrate
the functionality of the <code>hubEnsembles</code> package. This example
hub, stored in the <code>hubExamples</code> package, was generated with
modified forecasts from the FluSight forecasting challenge, a
collaborative modeling exercise run by the US Centers for Disease
Control and Prevention (CDC) since 2013 that solicits seasonal influenza
forecasts from outside modeling teams. The <code>hubExamples</code>
package includes model output data and target data (observed data
corresponding to each prediction target, sometimes known as “truth”
data) in the two forms defined by the hubverse: target time series data
and oracle output data. We load the <code>forecast_outputs</code> and
<code>forecast_target_ts</code> data objects containing the model output
and target time series data, respectively. Note that the toy model
outputs contain predictions for only a small subset rows of select
dates, locations, and output type IDs, far fewer than an actual modeling
hub would typically collect.</p>
<p>The model output data includes mean, median, quantile, and sample
forecasts of future incident influenza hospitalizations; as well as CDF
and PMF forecasts of hospitalization intensity (the latter made up of
categories determined by threshold of weekly hospital admissions per
100,000 population). Each forecast is made for five task ID variables,
including the location for which the forecast was made
(<code>location</code>), the date on which the forecast was made
(<code>reference_date</code>), the number of steps ahead
(<code>horizon</code>), the date of the forecast prediction (a
combination of the date the forecast was made and the forecast horizon,
<code>target_end_date</code>), and the forecast target
(<code>target</code>). Below we print a subset of this example model
output.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">otid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  mean <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  median <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  quantile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.25</span>, <span class="fl">0.75</span><span class="op">)</span>,</span>
<span>  sample <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2101"</span>, <span class="st">"2102"</span>, <span class="st">"2103"</span><span class="op">)</span>,</span>
<span>  pmf <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"low"</span>, <span class="st">"moderate"</span>, <span class="st">"high"</span>, <span class="st">"very high"</span><span class="op">)</span>,</span>
<span>  cdf <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">13</span>, <span class="fl">15</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">hubExamples</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/hubExamples/man/forecast_data.html" class="external-link">forecast_outputs</a></span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">output_type_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">otid</span><span class="op">)</span>,</span>
<span>    <span class="va">reference_date</span> <span class="op">==</span> <span class="st">"2022-12-17"</span>,</span>
<span>    <span class="va">location</span> <span class="op">==</span> <span class="st">"25"</span>,</span>
<span>    <span class="va">horizon</span> <span class="op">==</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">model_id</span>, <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html" class="external-link">desc</a></span><span class="op">(</span><span class="va">target</span><span class="op">)</span>, <span class="va">output_type</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">16</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 48 × 9</span></span></span>
<span><span class="co">#&gt;    model_id          reference_date target                    horizon location target_end_date output_type output_type_id   value</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                       <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> Flusight-baseline 2022-12-17     wk inc flu hosp                 1 25       2022-12-24      mean        <span style="color: #BB0000;">NA</span>             5.82<span style="color: #949494;">e</span>+2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> Flusight-baseline 2022-12-17     wk inc flu hosp                 1 25       2022-12-24      median      <span style="color: #BB0000;">NA</span>             5.82<span style="color: #949494;">e</span>+2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> Flusight-baseline 2022-12-17     wk inc flu hosp                 1 25       2022-12-24      quantile    0.25           5.66<span style="color: #949494;">e</span>+2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> Flusight-baseline 2022-12-17     wk inc flu hosp                 1 25       2022-12-24      quantile    0.75           5.98<span style="color: #949494;">e</span>+2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> Flusight-baseline 2022-12-17     wk inc flu hosp                 1 25       2022-12-24      sample      2101           6.06<span style="color: #949494;">e</span>+2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> Flusight-baseline 2022-12-17     wk inc flu hosp                 1 25       2022-12-24      sample      2102           5.76<span style="color: #949494;">e</span>+2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> Flusight-baseline 2022-12-17     wk inc flu hosp                 1 25       2022-12-24      sample      2103           5.78<span style="color: #949494;">e</span>+2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> Flusight-baseline 2022-12-17     wk flu hosp rate category       1 25       2022-12-24      pmf         low            9.70<span style="color: #949494;">e</span><span style="color: #BB0000;">-6</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> Flusight-baseline 2022-12-17     wk flu hosp rate category       1 25       2022-12-24      pmf         moderate       2.94<span style="color: #949494;">e</span><span style="color: #BB0000;">-3</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> Flusight-baseline 2022-12-17     wk flu hosp rate category       1 25       2022-12-24      pmf         high           7.35<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span> Flusight-baseline 2022-12-17     wk flu hosp rate category       1 25       2022-12-24      pmf         very high      9.24<span style="color: #949494;">e</span><span style="color: #BB0000;">-1</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span> Flusight-baseline 2022-12-17     wk flu hosp rate                1 25       2022-12-24      cdf         0.25           8.63<span style="color: #949494;">e</span><span style="color: #BB0000;">-9</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">13</span> Flusight-baseline 2022-12-17     wk flu hosp rate                1 25       2022-12-24      cdf         0.75           4.83<span style="color: #949494;">e</span><span style="color: #BB0000;">-8</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">14</span> Flusight-baseline 2022-12-17     wk flu hosp rate                1 25       2022-12-24      cdf         1              1.10<span style="color: #949494;">e</span><span style="color: #BB0000;">-7</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">15</span> Flusight-baseline 2022-12-17     wk flu hosp rate                1 25       2022-12-24      cdf         13             1.00<span style="color: #949494;">e</span>+0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">16</span> Flusight-baseline 2022-12-17     wk flu hosp rate                1 25       2022-12-24      cdf         15             1.00<span style="color: #949494;">e</span>+0</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 32 more rows</span></span></span></code></pre></div>
<p>The corresponding target time series data provide observed incident
influenza hospitalizations (<code>observation</code>) in a given week
(<code>date</code>) and for a given location (<code>location</code>).
This format of target data is generally used as calibration data for
generating forecasts or in conjunction with forecasts for
visualizations. (The other form of target data, oracle output, is
suitable for evaluating the forecasts post hoc, which is not in scope
for this vignette). The forecast-specific task ID variables
<code>reference_date</code> and <code>horizon</code> are not relevant
for the use cases of target time series data and are thus omitted.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu">hubExamples</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/hubExamples/man/forecast_data.html" class="external-link">forecast_target_ts</a></span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 × 3</span></span></span>
<span><span class="co">#&gt;    date       location observation</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 2020-01-11 01                 0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 2020-01-11 15                 0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 2020-01-11 18                 0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 2020-01-11 27                 0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 2020-01-11 30                 0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 2020-01-11 37                 0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 2020-01-11 48                 0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 2020-01-11 US                 1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 2020-01-18 01                 0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 2020-01-18 15                 0</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="creating-ensembles-with-simple_ensemble">Creating ensembles with <code>simple_ensemble</code><a class="anchor" aria-label="anchor" href="#creating-ensembles-with-simple_ensemble"></a>
</h2>
<p>The <code><a href="../reference/simple_ensemble.html">simple_ensemble()</a></code> function directly computes an
ensemble from component model outputs by combining them via some
function within each unique combination of task ID variables, output
types, and output type IDs. This function can be used to summarize
predictions of output types mean, median, quantile, CDF, and PMF. The
mechanics of the ensemble calculations are the same for each of the
output types, though the resulting statistical ensembling method differs
for different output types.</p>
<p>By default, <code><a href="../reference/simple_ensemble.html">simple_ensemble()</a></code> uses the mean for the
aggregation function and equal weights for all models, though the user
can create different types of weighted ensembles by specifying an
aggregation function and weights.</p>
<p>Using the default options for <code><a href="../reference/simple_ensemble.html">simple_ensemble()</a></code>, we can
generate an equally weighted mean ensemble for each unique combination
of values for the task ID variables, the <code>output_type</code> and
the <code>output_type_id</code>. This means different ensemble methods
will be used for different output types: for the <code>quantile</code>
output type in our example data, the resulting ensemble is a quantile
average, while for the mean, CDF, and PMF output types the ensemble is a
linear pool. The <code><a href="../reference/simple_ensemble.html">simple_ensemble()</a></code> function does not
support the sample output type, so we remove the sample predictions from
the forecast model outputs.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mean_ens</span> <span class="op">&lt;-</span> <span class="fu">hubExamples</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/hubExamples/man/forecast_data.html" class="external-link">forecast_outputs</a></span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">output_type</span> <span class="op">!=</span> <span class="st">"sample"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">hubEnsembles</span><span class="fu">::</span><span class="fu"><a href="../reference/simple_ensemble.html">simple_ensemble</a></span><span class="op">(</span></span>
<span>    model_id <span class="op">=</span> <span class="st">"simple-ensemble-mean"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>The resulting model output has the same structure as the original
model output data, with columns for model ID, task ID variables, output
type, output type ID, and value. We also use
<code>model_id = "simple-ensemble-mean"</code> to change the name of
this ensemble in the resulting model output; if not specified, the
default will be “hub-ensemble”. A subset of the predictions is printed
below.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mean_ens</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">output_type_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">otid</span><span class="op">)</span>,</span>
<span>    <span class="va">reference_date</span> <span class="op">==</span> <span class="st">"2022-12-17"</span>,</span>
<span>    <span class="va">location</span> <span class="op">==</span> <span class="st">"25"</span>,</span>
<span>    <span class="va">horizon</span> <span class="op">==</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 13 × 9</span></span></span>
<span><span class="co">#&gt;    model_id             reference_date target                    horizon location target_end_date output_type output_type_id      value</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                       <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>               <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> simple-ensemble-mean 2022-12-17     wk flu hosp rate                1 25       2022-12-24      cdf         0.25             0.000<span style="text-decoration: underline;">284</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> simple-ensemble-mean 2022-12-17     wk flu hosp rate                1 25       2022-12-24      cdf         0.75             0.000<span style="text-decoration: underline;">556</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> simple-ensemble-mean 2022-12-17     wk flu hosp rate                1 25       2022-12-24      cdf         1                0.000<span style="text-decoration: underline;">767</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> simple-ensemble-mean 2022-12-17     wk flu hosp rate                1 25       2022-12-24      cdf         13               0.947   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> simple-ensemble-mean 2022-12-17     wk flu hosp rate                1 25       2022-12-24      cdf         15               0.977   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> simple-ensemble-mean 2022-12-17     wk flu hosp rate category       1 25       2022-12-24      pmf         high             0.151   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> simple-ensemble-mean 2022-12-17     wk flu hosp rate category       1 25       2022-12-24      pmf         low              0.004<span style="text-decoration: underline;">37</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> simple-ensemble-mean 2022-12-17     wk flu hosp rate category       1 25       2022-12-24      pmf         moderate         0.023<span style="text-decoration: underline;">3</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> simple-ensemble-mean 2022-12-17     wk flu hosp rate category       1 25       2022-12-24      pmf         very high        0.821   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> simple-ensemble-mean 2022-12-17     wk inc flu hosp                 1 25       2022-12-24      mean        <span style="color: #BB0000;">NA</span>             627.      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span> simple-ensemble-mean 2022-12-17     wk inc flu hosp                 1 25       2022-12-24      median      <span style="color: #BB0000;">NA</span>             620.      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span> simple-ensemble-mean 2022-12-17     wk inc flu hosp                 1 25       2022-12-24      quantile    0.25           542.      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">13</span> simple-ensemble-mean 2022-12-17     wk inc flu hosp                 1 25       2022-12-24      quantile    0.75           704.</span></span></code></pre></div>
<div class="section level3">
<h3 id="changing-the-aggregation-function">Changing the aggregation function<a class="anchor" aria-label="anchor" href="#changing-the-aggregation-function"></a>
</h3>
<p>We can change the function that is used to aggregate model outputs.
For example, we may want to calculate a median of the component models’
submitted values for each quantile. We do so by specifying
<code>agg_fun = median</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">median_ens</span> <span class="op">&lt;-</span> <span class="fu">hubExamples</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/hubExamples/man/forecast_data.html" class="external-link">forecast_outputs</a></span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">output_type</span> <span class="op">!=</span> <span class="st">"sample"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">hubEnsembles</span><span class="fu">::</span><span class="fu"><a href="../reference/simple_ensemble.html">simple_ensemble</a></span><span class="op">(</span></span>
<span>    agg_fun <span class="op">=</span> <span class="va">median</span>,</span>
<span>    model_id <span class="op">=</span> <span class="st">"simple-ensemble-median"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Custom functions can also be passed into the <code>agg_fun</code>
argument. We illustrate this by defining a custom function to compute
the ensemble prediction as a geometric mean of the component model
predictions. Any custom function to be used must have an argument
<code>x</code> for the vector of numeric values to summarize, and if
relevant, an argument <code>w</code> of numeric weights.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">geometric_mean</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/prod.html" class="external-link">prod</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="va">n</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">geometric_mean_ens</span> <span class="op">&lt;-</span> <span class="fu">hubExamples</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/hubExamples/man/forecast_data.html" class="external-link">forecast_outputs</a></span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">output_type</span> <span class="op">!=</span> <span class="st">"sample"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">hubEnsembles</span><span class="fu">::</span><span class="fu"><a href="../reference/simple_ensemble.html">simple_ensemble</a></span><span class="op">(</span></span>
<span>    agg_fun <span class="op">=</span> <span class="va">geometric_mean</span>,</span>
<span>    model_id <span class="op">=</span> <span class="st">"simple-ensemble-geometric"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>As expected, the mean, median, and geometric mean each give us
slightly different resulting ensembles. The median point estimates, 50%
prediction intervals, and 90% prediction intervals in the figure below
demonstrate this. Note that the geometric mean ensemble and simple mean
ensemble generate similar estimates in this case of predicting weekly
incident influenza hospitalizations in Massachusetts.</p>
<p><img src="hubEnsembles_files/figure-html/plot-ensembles-1.png" width="768"></p>
</div>
<div class="section level3">
<h3 id="weighting-model-contributions">Weighting model contributions<a class="anchor" aria-label="anchor" href="#weighting-model-contributions"></a>
</h3>
<p>We can weight the contributions of each model in the ensemble using
the <code>weights</code> argument of <code><a href="../reference/simple_ensemble.html">simple_ensemble()</a></code>.
This argument takes a <code>data.frame</code> that should include a
<code>model_id</code> column containing each unique model ID and a
<code>weight</code> column. In the following example, we include the
baseline model in the ensemble, but give it less weight than the other
forecasts.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  model_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"MOBS-GLEAM_FLUH"</span>, <span class="st">"PSI-DICE"</span>, <span class="st">"Flusight-baseline"</span><span class="op">)</span>,</span>
<span>  weight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="fl">0.4</span>, <span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">weighted_mean_ens</span> <span class="op">&lt;-</span> <span class="fu">hubExamples</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/hubExamples/man/forecast_data.html" class="external-link">forecast_outputs</a></span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">output_type</span> <span class="op">!=</span> <span class="st">"sample"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">hubEnsembles</span><span class="fu">::</span><span class="fu"><a href="../reference/simple_ensemble.html">simple_ensemble</a></span><span class="op">(</span></span>
<span>    weights <span class="op">=</span> <span class="va">model_weights</span>,</span>
<span>    model_id <span class="op">=</span> <span class="st">"simple-ensemble-weighted-mean"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">weighted_mean_ens</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 × 9</span></span></span>
<span><span class="co">#&gt;    model_id                      reference_date target           horizon location target_end_date output_type output_type_id  value</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                         <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> simple-ensemble-weighted-mean 2022-11-19     wk flu hosp rate       0 25       2022-11-19      cdf         0.25           0.012<span style="text-decoration: underline;">9</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> simple-ensemble-weighted-mean 2022-11-19     wk flu hosp rate       0 25       2022-11-19      cdf         0.5            0.115 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> simple-ensemble-weighted-mean 2022-11-19     wk flu hosp rate       0 25       2022-11-19      cdf         0.75           0.546 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> simple-ensemble-weighted-mean 2022-11-19     wk flu hosp rate       0 25       2022-11-19      cdf         1              0.805 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> simple-ensemble-weighted-mean 2022-11-19     wk flu hosp rate       0 25       2022-11-19      cdf         1.25           0.910 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> simple-ensemble-weighted-mean 2022-11-19     wk flu hosp rate       0 25       2022-11-19      cdf         1.5            0.964 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> simple-ensemble-weighted-mean 2022-11-19     wk flu hosp rate       0 25       2022-11-19      cdf         1.75           0.989 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> simple-ensemble-weighted-mean 2022-11-19     wk flu hosp rate       0 25       2022-11-19      cdf         10             1     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> simple-ensemble-weighted-mean 2022-11-19     wk flu hosp rate       0 25       2022-11-19      cdf         10.25          1     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> simple-ensemble-weighted-mean 2022-11-19     wk flu hosp rate       0 25       2022-11-19      cdf         10.5           1</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="creating-ensembles-with-linear_pool">Creating ensembles with <code>linear_pool</code><a class="anchor" aria-label="anchor" href="#creating-ensembles-with-linear_pool"></a>
</h2>
<p>The <code><a href="../reference/linear_pool.html">linear_pool()</a></code> function implements the linear opinion
pool (LOP, also known as a distributional mixture) method (<a href="https://doi.org/10.1214/aoms/1177704873" class="external-link">Stone 1961</a>, <a href="https://doi.org/10.1287/mnsc.1120.1667" class="external-link">Lichtendahl 2013</a>) when
ensembling predictions. This function can be used to combine predictions
with output types mean, CDF, PMF, sample, and quantile. Unlike
<code><a href="../reference/simple_ensemble.html">simple_ensemble()</a></code>, this function handles its computation
differently based on the output type. For the CDF, PMF, and mean output
types, the linear pool method is equivalent to calling
<code><a href="../reference/simple_ensemble.html">simple_ensemble()</a></code> with a mean aggregation function, since
<code><a href="../reference/simple_ensemble.html">simple_ensemble()</a></code> produces a linear pool prediction (an
average of individual model cumulative or bin probabilities).</p>
<p>For the sample output type, the LOP method pools the input sample
predictions into a combined ensemble distribution. By default, the
<code><a href="../reference/linear_pool.html">linear_pool()</a></code> function will simply collect and return all
provided samples, so that the number of samples for the ensemble is
equal to the sum of the number of samples from all individual models.
However, the user may also specify a number of sample predictions for
the ensemble to return using the <code>n_output_samples</code> argument,
in which case a random subset of predictions from individual models will
be selected to create the linear pool of samples so that all component
models are represented equally. This random selection of samples is
stratified by model so that approximately the same number of samples
from each individual model is included in the ensemble. See <a href="#requesting-an-ensemble-that-subsets-samples">Requesting an
ensemble that subsets samples</a> for more details, including an
explanation of a few additional hubverse concepts relevant to the
process.</p>
<p>For the quantile output type, the <code><a href="../reference/linear_pool.html">linear_pool()</a></code> function
first must approximate a full probability distribution using the
value-quantile level pairs from each component model. As a default, this
is done with functions in the <code>distfromq</code> package, which
defaults to fitting a monotonic cubic spline for the interior and a
Gaussian normal distribution for the tails. Quasi-random samples are
drawn from each distributional estimate, which are then collected and
used to extract the desired quantiles from the final ensemble
distribution.</p>
<p>Using the default options for <code><a href="../reference/linear_pool.html">linear_pool()</a></code>, we can
generate an equally-weighted linear pool for each of the output types in
our example hub (except for the median output type, which must be
excluded). The resulting distribution for the linear pool of quantiles
is estimated using a default of <code>n_samples = 1e4</code>
quasi-random samples drawn from the distribution of each component
model.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linear_pool_norm</span> <span class="op">&lt;-</span> <span class="fu">hubExamples</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/hubExamples/man/forecast_data.html" class="external-link">forecast_outputs</a></span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">output_type</span> <span class="op">!=</span> <span class="st">"median"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">hubEnsembles</span><span class="fu">::</span><span class="fu"><a href="../reference/linear_pool.html">linear_pool</a></span><span class="op">(</span>model_id <span class="op">=</span> <span class="st">"linear-pool-normal"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">linear_pool_norm</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 × 9</span></span></span>
<span><span class="co">#&gt;    model_id           reference_date target           horizon location target_end_date output_type output_type_id  value</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> linear-pool-normal 2022-11-19     wk flu hosp rate       0 25       2022-11-19      cdf         0.25           0.017<span style="text-decoration: underline;">6</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> linear-pool-normal 2022-11-19     wk flu hosp rate       0 25       2022-11-19      cdf         0.5            0.118 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> linear-pool-normal 2022-11-19     wk flu hosp rate       0 25       2022-11-19      cdf         0.75           0.550 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> linear-pool-normal 2022-11-19     wk flu hosp rate       0 25       2022-11-19      cdf         1              0.819 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> linear-pool-normal 2022-11-19     wk flu hosp rate       0 25       2022-11-19      cdf         1.25           0.919 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> linear-pool-normal 2022-11-19     wk flu hosp rate       0 25       2022-11-19      cdf         1.5            0.968 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> linear-pool-normal 2022-11-19     wk flu hosp rate       0 25       2022-11-19      cdf         1.75           0.990 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> linear-pool-normal 2022-11-19     wk flu hosp rate       0 25       2022-11-19      cdf         10             1     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> linear-pool-normal 2022-11-19     wk flu hosp rate       0 25       2022-11-19      cdf         10.25          1     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> linear-pool-normal 2022-11-19     wk flu hosp rate       0 25       2022-11-19      cdf         10.5           1</span></span></code></pre></div>
<p>In the figure below, we compare ensemble results generated by
<code><a href="../reference/simple_ensemble.html">simple_ensemble()</a></code> and <code><a href="../reference/linear_pool.html">linear_pool()</a></code> for model
outputs of output types PMF and quantile. Panel A shows PMF type
predictions of Massachusetts incident influenza hospitalization
intensity while Panel B shows quantile type predictions of Massachusetts
weekly incident influenza hospitalizations. As expected, the results
from the two functions are equivalent for the PMF output type: for this
output type, the <code><a href="../reference/simple_ensemble.html">simple_ensemble()</a></code> method averages the
predicted probability of each category across the component models,
which is the definition of the linear pool ensemble method. This is not
the case for the quantile output type, because the
<code><a href="../reference/simple_ensemble.html">simple_ensemble()</a></code> is computing a quantile average.</p>
<p><img src="hubEnsembles_files/figure-html/plot-ex-quantile-and-linear-pool-1.png" width="960"></p>
<div class="section level3">
<h3 id="weighting-model-contributions-1">Weighting model contributions<a class="anchor" aria-label="anchor" href="#weighting-model-contributions-1"></a>
</h3>
<p>Like with <code><a href="../reference/simple_ensemble.html">simple_ensemble()</a></code>, we can change the default
function settings. For example, weights that determine a model’s
contribution to the resulting ensemble may be provided. (Note that we
must exclude the sample output type here because it is not yet supported
for weighted ensembles.)</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  model_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"MOBS-GLEAM_FLUH"</span>, <span class="st">"PSI-DICE"</span>, <span class="st">"Flusight-baseline"</span><span class="op">)</span>,</span>
<span>  weight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="fl">0.4</span>, <span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">weighted_linear_pool_norm</span> <span class="op">&lt;-</span> <span class="fu">hubExamples</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/hubExamples/man/forecast_data.html" class="external-link">forecast_outputs</a></span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">output_type</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"median"</span>, <span class="st">"sample"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">hubEnsembles</span><span class="fu">::</span><span class="fu"><a href="../reference/linear_pool.html">linear_pool</a></span><span class="op">(</span></span>
<span>    weights <span class="op">=</span> <span class="va">model_weights</span>,</span>
<span>    model_id <span class="op">=</span> <span class="st">"linear-pool-weighted"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">weighted_linear_pool_norm</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 × 9</span></span></span>
<span><span class="co">#&gt;    model_id             reference_date target           horizon location target_end_date output_type output_type_id  value</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> linear-pool-weighted 2022-11-19     wk flu hosp rate       0 25       2022-11-19      cdf         0.25           0.012<span style="text-decoration: underline;">9</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> linear-pool-weighted 2022-11-19     wk flu hosp rate       0 25       2022-11-19      cdf         0.5            0.115 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> linear-pool-weighted 2022-11-19     wk flu hosp rate       0 25       2022-11-19      cdf         0.75           0.546 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> linear-pool-weighted 2022-11-19     wk flu hosp rate       0 25       2022-11-19      cdf         1              0.805 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> linear-pool-weighted 2022-11-19     wk flu hosp rate       0 25       2022-11-19      cdf         1.25           0.910 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> linear-pool-weighted 2022-11-19     wk flu hosp rate       0 25       2022-11-19      cdf         1.5            0.964 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> linear-pool-weighted 2022-11-19     wk flu hosp rate       0 25       2022-11-19      cdf         1.75           0.989 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> linear-pool-weighted 2022-11-19     wk flu hosp rate       0 25       2022-11-19      cdf         10             1     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> linear-pool-weighted 2022-11-19     wk flu hosp rate       0 25       2022-11-19      cdf         10.25          1     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> linear-pool-weighted 2022-11-19     wk flu hosp rate       0 25       2022-11-19      cdf         10.5           1</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="changing-the-parametric-family-used-for-extrapolation-into-distribution-tails">Changing the parametric family used for extrapolation into
distribution tails<a class="anchor" aria-label="anchor" href="#changing-the-parametric-family-used-for-extrapolation-into-distribution-tails"></a>
</h3>
<p>We can also change the distribution that <code>distfromq</code> uses
to approximate the tails of component models’ predictive distributions
to either log normal or Cauchy using the <code>tail_dist</code>
argument. This choice usually does not have a large impact on the
resulting ensemble distribution, though, and can only be seen in its
outer edges. (For more details and other function options, see the
documentation in the <a href="https://reichlab.io/distfromq/" class="external-link"><code>distfromq</code>
package</a>.)</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linear_pool_lnorm</span> <span class="op">&lt;-</span> <span class="fu">hubExamples</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/hubExamples/man/forecast_data.html" class="external-link">forecast_outputs</a></span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">output_type</span> <span class="op">==</span> <span class="st">"quantile"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">hubEnsembles</span><span class="fu">::</span><span class="fu"><a href="../reference/linear_pool.html">linear_pool</a></span><span class="op">(</span></span>
<span>    model_id <span class="op">=</span> <span class="st">"linear-pool-lognormal"</span>,</span>
<span>    tail_dist <span class="op">=</span> <span class="st">"lnorm"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">linear_pool_cauchy</span> <span class="op">&lt;-</span> <span class="fu">hubExamples</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/hubExamples/man/forecast_data.html" class="external-link">forecast_outputs</a></span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">output_type</span> <span class="op">==</span> <span class="st">"quantile"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">hubEnsembles</span><span class="fu">::</span><span class="fu"><a href="../reference/linear_pool.html">linear_pool</a></span><span class="op">(</span></span>
<span>    model_id <span class="op">=</span> <span class="st">"linear-pool-cauchy"</span>,</span>
<span>    tail_dist <span class="op">=</span> <span class="st">"cauchy"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="requesting-an-ensemble-that-subsets-samples">Requesting an ensemble that subsets samples<a class="anchor" aria-label="anchor" href="#requesting-an-ensemble-that-subsets-samples"></a>
</h3>
<p>If one wishes to request a subsetted ensemble of samples, it becomes
important to distinguish between marginal and joint predictive
distributions, as the dependence structure must be defined in the call
to <code><a href="../reference/linear_pool.html">linear_pool()</a></code>. The concepts of the compound task ID set
and derived task ID variables must also be understood since they are
used to help identify the dependence structure (or lack thereof, in the
case of marginal distributions) of the ensembled predictive
distributions.</p>
<p>In the hubverse, all output types summarize predictions from marginal
distributions, e.g. for a single location and time point. The sample
output type is unique in that <strong>it can additionally represent
predictions from joint predictive distributions</strong>. This means
that samples may encode dependence across combinations of multiple
values for task ID variables, e.g. across multiple locations and/or time
points. In this case, sample predictions with the same index (specified
by the <code>output_type_id</code>) from a particular model may be
assumed to correspond to a single sample from a joint distribution.</p>
<p>The example data for the sample output type has task ID variables
<code>"reference_date"</code>, <code>"location"</code>,
<code>"horizon"</code>, <code>"target"</code>, and
<code>"target_end_date"</code>. In this example, the samples capture
dependence across different forecast <code>"horizon"</code>s; however,
the samples do not capture dependence across different
<code>"reference_date"</code>s, <code>"location"</code>s, or
<code>"target"</code>s.</p>
<p>When specifically requesting a linear pool made up of a subset of the
input sample predictions, the user must identify the dependence
structure using the <code>compound_taskid_set</code> parameter to ensure
the resulting ensemble is valid. The compound task ID set consists of
independent task ID variables that, together, identify a “compound
modeling task” corresponding to a single modeled unit with a
multivariate outcome of interest. Samples summarizing a marginal
distribution will generally have a compound task ID set composed of all
the task ID variables<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Derived task IDs are the one exception to this rule&lt;/p&gt;"><sup>1</sup></a>. On the other hand, samples summarizing a
joint distribution will have a compound task ID set that only contains
task ID variables for which the joint distribution does not capture
dependence.</p>
<p>For example, a compound task could be predicting the number of weekly
incident influenza hospitalizations (<code>"target"</code>) in
Massachusetts (<code>"location"</code>) starting on November 19, 2022
(<code>"reference_date"</code>). Here, <code>"horizon"</code> is not
part of the compound task ID set, indicating that sample predictions
made at each horizon depend on those for the other horizons within every
compound task for the sample output type. Each sample can therefore be
interpreted as a trajectory giving a possible path of hospitalizations
over time. These three task id variables (<code>"reference_date"</code>,
<code>"location"</code>, and <code>"target"</code>) make up the compound
task ID set that is specified in the call to
<code><a href="../reference/linear_pool.html">linear_pool()</a></code>.</p>
<p>Derived task IDs are another subset of task ID variables whose values
are “derived” solely from a combination of the values from other task ID
variables, which may or may not be part of the compound task ID set. In
the above example, the <code>"target_end_date"</code> for a given
forecast is derived from the combination of
<code>"reference_date"</code> and <code>"horizon"</code>, and so it is
specified as the argument for <code>derived_task_ids</code>. The derived
task <code>"target_end_date"</code> is not part of the compound task ID
set because <code>"reference_date"</code> and <code>"horizon"</code> are
not both part of the compound task ID set.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">hubExamples</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/hubExamples/man/forecast_data.html" class="external-link">forecast_outputs</a></span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">output_type</span> <span class="op">==</span> <span class="st">"sample"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>output_type_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">output_type_id</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># make indices numeric for readability</span></span>
<span>  <span class="fu">hubEnsembles</span><span class="fu">::</span><span class="fu"><a href="../reference/linear_pool.html">linear_pool</a></span><span class="op">(</span></span>
<span>    weights <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    model_id <span class="op">=</span> <span class="st">"linear-pool-joint"</span>,</span>
<span>    task_id_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"reference_date"</span>, <span class="st">"location"</span>, <span class="st">"horizon"</span>, <span class="st">"target"</span>, <span class="st">"target_end_date"</span><span class="op">)</span>,</span>
<span>    compound_taskid_set <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"reference_date"</span>, <span class="st">"location"</span>, <span class="st">"target"</span><span class="op">)</span>,</span>
<span>    derived_task_ids <span class="op">=</span> <span class="st">"target_end_date"</span>,</span>
<span>    n_output_samples <span class="op">=</span> <span class="fl">100</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1,600 × 9</span></span></span>
<span><span class="co">#&gt;    model_id          reference_date target          horizon location target_end_date output_type output_type_id value</span></span>
<span><span class="co">#&gt;  <span style="color: #BCBCBC;">*</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> linear-pool-joint 2022-11-19     wk inc flu hosp       0 25       2022-11-19      sample                   1     2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> linear-pool-joint 2022-11-19     wk inc flu hosp       0 25       2022-11-19      sample                   2    47</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> linear-pool-joint 2022-11-19     wk inc flu hosp       0 25       2022-11-19      sample                   3    56</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> linear-pool-joint 2022-11-19     wk inc flu hosp       0 25       2022-11-19      sample                   4    47</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> linear-pool-joint 2022-11-19     wk inc flu hosp       0 25       2022-11-19      sample                   5    64</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> linear-pool-joint 2022-11-19     wk inc flu hosp       0 25       2022-11-19      sample                   6    55</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> linear-pool-joint 2022-11-19     wk inc flu hosp       0 25       2022-11-19      sample                   7    54</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> linear-pool-joint 2022-11-19     wk inc flu hosp       0 25       2022-11-19      sample                   8    56</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> linear-pool-joint 2022-11-19     wk inc flu hosp       0 25       2022-11-19      sample                   9    58</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> linear-pool-joint 2022-11-19     wk inc flu hosp       0 25       2022-11-19      sample                  10    36</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1,590 more rows</span></span></span></code></pre></div>
<p>Generally, the derived task IDs are not needed to identify a single
model unit with a multivariate outcome of interest (the purpose of the
compound task id set), <strong>unless</strong> all of the task ID
variables their values depend upon are already a part of the compound
task ID set.</p>
<p>Not all model outputs will contain derived task IDs, in which case
the argument may be set to <code>NULL</code> (the default value).
However, it is important to provide the <code><a href="../reference/linear_pool.html">linear_pool()</a></code>
function with any derived task IDs, as they are used to check that the
provided compound task ID set is compatible with the input sample
predictions to help ensure the resulting (multivariate) ensemble is
valid.</p>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Li Shandross, Emily Howerton, Evan L Ray.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3. PR Previews built by <a href="https://www.netlify.com" class="external-link">Netlify</a>. Provided without <strong>any warranty</strong>.</p>
</div>

    </footer>
</div>





  </body>
</html>
